local DarkFusion = {}

-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Main UI ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DarkFusionUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = PlayerGui

-- Theme colors
local backgroundColor = Color3.fromRGB(20, 20, 20)
local accentColor = Color3.fromRGB(120, 0, 255)
local white = Color3.fromRGB(255, 255, 255)

-- Helper: Rounded corners
local function roundify(obj, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius or 10)
	corner.Parent = obj
end

-- Helper: Create UI button with Lucide icon
local function createButtonWithIcon(text, iconId, callback)
	local btn = Instance.new("TextButton")
	btn.Text = text
	btn.Size = UDim2.new(1, -20, 0, 30)
	btn.BackgroundColor3 = accentColor
	btn.TextColor3 = white
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.AutoButtonColor = true
	roundify(btn)
	
	local icon = Instance.new("ImageLabel", btn)
	icon.Size = UDim2.new(0, 20, 0, 20)
	icon.Position = UDim2.new(0, 10, 0.5, -10)
	icon.Image = "rbxassetid://" .. iconId
	icon.BackgroundTransparency = 1
	
	btn.MouseButton1Click:Connect(callback)
	return btn
end

-- Recursive visibility setter
local function setChildrenVisible(parent, visible)
	for _, child in ipairs(parent:GetChildren()) do
		if child:IsA("GuiObject") and child.Name ~= "TopBar" then
			child.Visible = visible
		end
	end
end

-- Main frame
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Name = "MainFrame"
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.Size = UDim2.new(0, 400, 0, 400)
mainFrame.BackgroundColor3 = backgroundColor
mainFrame.BorderSizePixel = 0
roundify(mainFrame)

-- TopBar (title bar)
local topBar = Instance.new("Frame", mainFrame)
topBar.Name = "TopBar"
topBar.Size = UDim2.new(1, 0, 0, 40)
topBar.BackgroundColor3 = accentColor
roundify(topBar)

local title = Instance.new("TextLabel", topBar)
title.Text = "DarkFusion Hub"
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextColor3 = white
title.BackgroundTransparency = 1
title.Size = UDim2.new(1, 0, 1, 0)

-- Close Button
local closeBtn = createButtonWithIcon("X", "123456", function()
	screenGui:Destroy()
end)
closeBtn.Position = UDim2.new(1, -30, 0, 0)
closeBtn.Size = UDim2.new(0, 30, 1, 0)
closeBtn.Parent = topBar

-- Minimize Button
local minimized = false
local minimizeBtn = createButtonWithIcon("-", "123457", function()
	minimized = not minimized
	if minimized then
		mainFrame.Size = UDim2.new(0, 400, 0, 40)
		setChildrenVisible(mainFrame, false)
		topBar.Visible = true
	else
		mainFrame.Size = UDim2.new(0, 400, 0, 400)
		setChildrenVisible(mainFrame, true)
	end
end)
minimizeBtn.Position = UDim2.new(1, -60, 0, 0)
minimizeBtn.Size = UDim2.new(0, 30, 1, 0)
minimizeBtn.Parent = topBar

-- Credits
local credits = Instance.new("TextLabel", mainFrame)
credits.Text = "Made by VoidedX"
credits.TextColor3 = white
credits.Font = Enum.Font.Gotham
credits.TextSize = 12
credits.BackgroundTransparency = 1
credits.Position = UDim2.new(0, 10, 1, -20)
credits.Size = UDim2.new(0, 200, 0, 20)
credits.TextXAlignment = Enum.TextXAlignment.Left

-- Draggable TopBar
local dragging, dragStart, startPos = false
topBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- Helper: Create Toggle
function DarkFusion:CreateToggle(parent, name, callback)
	local toggle = Instance.new("TextButton", parent)
	toggle.Size = UDim2.new(1, -20, 0, 30)
	toggle.Text = "[ OFF ] " .. name
	toggle.BackgroundColor3 = backgroundColor
	toggle.TextColor3 = white
	toggle.Font = Enum.Font.Gotham
	toggle.TextSize = 14
	toggle.AutoButtonColor = false
	roundify(toggle)

	local enabled = false
	toggle.MouseButton1Click:Connect(function()
		enabled = not enabled
		toggle.Text = (enabled and "[ ON ] " or "[ OFF ] ") .. name
		callback(enabled)
	end)
end

-- Helper: Create Slider
function DarkFusion:CreateSlider(parent, name, min, max, default, callback)
	local frame = Instance.new("Frame", parent)
	frame.Size = UDim2.new(1, -20, 0, 50)
	frame.BackgroundColor3 = backgroundColor
	roundify(frame)

	local label = Instance.new("TextLabel", frame)
	label.Text = name .. ": " .. tostring(default)
	label.Size = UDim2.new(1, 0, 0.4, 0)
	label.TextColor3 = white
	label.BackgroundTransparency = 1
	label.Font = Enum.Font.Gotham
	label.TextSize = 14

	local slider = Instance.new("Frame", frame)
	slider.Position = UDim2.new(0, 0, 0.5, 0)
	slider.Size = UDim2.new(1, 0, 0.5, -5)
	slider.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	roundify(slider)

	local fill = Instance.new("Frame", slider)
	fill.BackgroundColor3 = accentColor
	fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
	fill.BorderSizePixel = 0
	fill.Name = "Fill"
	roundify(fill)

	-- Correct calculation to adjust the position of the fill relative to the slider
	local function updateFill(x)
		local rel = (x - slider.AbsolutePosition.X) / slider.AbsoluteSize.X
		rel = math.clamp(rel, 0, 1)
		local val = math.floor(min + (max - min) * rel)
		fill.Size = UDim2.new(rel, 0, 1, 0)
		label.Text = name .. ": " .. val
		callback(val)
	end

	-- Correct initial position of the slider based on the default value
	updateFill(slider.AbsolutePosition.X + (fill.Size.X.Offset * (default / (max - min))))

	local dragging = false
	slider.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			updateFill(input.Position.X)
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			updateFill(input.Position.X)
		end
	end)
end

-- Helper: Create Tab
function DarkFusion:CreateTab(name)
	local tab = Instance.new("ScrollingFrame")
	tab.Name = name
	tab.Size = UDim2.new(1, 0, 1, -60)
	tab.Position = UDim2.new(0, 0, 0, 40)
	tab.CanvasSize = UDim2.new(0, 0, 0, 0)
	tab.ScrollBarThickness = 4
	tab.BackgroundColor3 = backgroundColor
	tab.BorderSizePixel = 0
	tab.AutomaticCanvasSize = Enum.AutomaticSize.Y

	local layout = Instance.new("UIListLayout", tab)
	layout.Padding = UDim.new(0, 10)

	return tab
end

-- Final Step: Add your custom code for the UI
local exampleTab = DarkFusion:CreateTab("Main")
exampleTab.Parent = mainFrame

-- Example Usage:
DarkFusion:CreateToggle(exampleTab, "Enable Feature", function(state)
	print("Feature Toggled:", state)
end)

DarkFusion:CreateSlider(exampleTab, "WalkSpeed", 10, 100, 16, function(value)
	game.Players.LocalPlayer.Character.Humanoid.WalkSpeed = value
end)

-- Return DarkFusion table so it can be used after loadstring execution
return DarkFusion
